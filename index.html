<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Müzik Editörü (Final Fix)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide İkonları -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: black; color: white; margin: 0; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Apple Style Spring Animation for Arrow */
        .spring-rotate {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Button Entry Animation */
        .sync-btn-enter {
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translate(-50%, 20px) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        /* Smooth Hide */
        .sync-btn-exit {
            opacity: 0;
            transform: translate(-50%, 10px) scale(0.95);
            transition: all 0.3s ease-out;
            pointer-events: none;
        }
        
        .sync-btn-visible {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. AYARLAR VE KÜTÜPHANE BAĞLANTILARI ---
        const { useState, useRef, useEffect, useMemo } = React;

        const Icon = ({ name, size = 24, className, fill, ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', {
                xmlns: "http://www.w3.org/2000/svg",
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: fill || "none",
                stroke: "currentColor",
                strokeWidth: 2,
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className,
                ...props
            }, iconData.map((child, index) => 
                React.createElement(child[0], { key: index, ...child[1] })
            ));
        };

        const Play = (p) => <Icon name="Play" {...p} />;
        const Pause = (p) => <Icon name="Pause" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const Music = (p) => <Icon name="Music" {...p} />;
        const AlertCircle = (p) => <Icon name="AlertCircle" {...p} />;
        const Loader2 = (p) => <Icon name="Loader2" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Key = (p) => <Icon name="Key" {...p} />;
        const ArrowLeft = (p) => <Icon name="ArrowLeft" {...p} />;
        const ArrowUp = (p) => <Icon name="ArrowUp" {...p} />;
        const Disc = (p) => <Icon name="Disc" {...p} />;
        const CheckCircle = (p) => <Icon name="CheckCircle" {...p} />;
        const Edit3 = (p) => <Icon name="Edit3" {...p} />;
        const Zap = (p) => <Icon name="Zap" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Menu = (p) => <Icon name="Menu" {...p} />;
        const FileJson = (p) => <Icon name="FileJson" {...p} />;
        const Music2 = (p) => <Icon name="Music2" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const RefreshCw = (p) => <Icon name="RefreshCw" {...p} />;

        // --- KAPAKLAR ---
        const ArtCyber = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#050505]"><defs><linearGradient id="cyberGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#ff0080" /><stop offset="100%" stopColor="#7928ca" /></linearGradient><filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><rect width="100" height="100" fill="#111" /><path d="M0 100 L100 0" stroke="url(#cyberGrad)" strokeWidth="0.5" opacity="0.5"/><circle cx="50" cy="50" r="25" fill="none" stroke="url(#cyberGrad)" strokeWidth="1" filter="url(#glow)" /><circle cx="50" cy="50" r="35" fill="none" stroke="#333" strokeWidth="0.5" strokeDasharray="4 2" /><path d="M50 25 L50 75 M25 50 L75 50" stroke="#fff" strokeWidth="0.5" opacity="0.2" /><rect x="45" y="45" width="10" height="10" fill="#fff" transform="rotate(45 50 50)" /></svg>);
        const ArtVinyl = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#1a1a1a]"><defs><radialGradient id="vinylGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" stopColor="#333" /><stop offset="40%" stopColor="#111" /><stop offset="42%" stopColor="#222" /><stop offset="45%" stopColor="#111" /><stop offset="60%" stopColor="#111" /><stop offset="62%" stopColor="#222" /><stop offset="100%" stopColor="#000" /></radialGradient></defs><circle cx="50" cy="50" r="45" fill="url(#vinylGrad)" /><circle cx="50" cy="50" r="15" fill="#eab308" /><circle cx="50" cy="50" r="2" fill="#000" /><path d="M50 50 Q 70 30 90 50" stroke="#fff" strokeWidth="2" opacity="0.1" fill="none" /><text x="50" y="45" fontSize="4" textAnchor="middle" fill="#000" fontWeight="bold" fontFamily="monospace">GEMINI RECORDS</text><text x="50" y="58" fontSize="3" textAnchor="middle" fill="#000" fontFamily="monospace">SIDE A</text></svg>);
        const ArtAbstract = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#0f172a]"><circle cx="20" cy="20" r="40" fill="#3b82f6" opacity="0.4" /><circle cx="80" cy="80" r="30" fill="#ec4899" opacity="0.4" /><rect x="0" y="0" width="100" height="100" fill="url(#grid)" opacity="0.1"/><path d="M0 50 Q 25 80 50 50 T 100 50" fill="none" stroke="#fff" strokeWidth="1" /><path d="M0 60 Q 25 90 50 60 T 100 60" fill="none" stroke="#fff" strokeWidth="0.5" opacity="0.5" /><circle cx="50" cy="50" r="10" fill="white" fillOpacity="0.1" stroke="white" strokeWidth="1"/></svg>);
        const ArtWave = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-black"><defs><linearGradient id="waveG" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stopColor="#4ade80"/><stop offset="100%" stopColor="#06b6d4"/></linearGradient></defs><path d="M0 50 C 20 40 30 60 50 50 C 70 40 80 60 100 50 L 100 100 L 0 100 Z" fill="url(#waveG)" opacity="0.8"/><path d="M0 60 C 20 50 30 70 50 60 C 70 50 80 70 100 60 L 100 100 L 0 100 Z" fill="url(#waveG)" opacity="0.4"/><circle cx="70" cy="30" r="5" fill="#fff" /></svg>);
        const ArtRetro = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#2a0a1a]"><circle cx="50" cy="80" r="40" fill="#f59e0b" /><rect x="0" y="50" width="100" height="50" fill="#000" opacity="0.5" /><line x1="0" y1="50" x2="100" y2="50" stroke="#ec4899" strokeWidth="1" /><line x1="0" y1="60" x2="100" y2="60" stroke="#ec4899" strokeWidth="1" /><line x1="0" y1="75" x2="100" y2="75" stroke="#ec4899" strokeWidth="1" /><path d="M20 100 L40 50 M60 50 L80 100" stroke="#ec4899" strokeWidth="1" /></svg>);

        const ArtComponents = [ArtCyber, ArtVinyl, ArtAbstract, ArtWave, ArtRetro]; 
        const ANIMATION_OFFSET_MS = 300; 

        // --- UYGULAMA ---
        function App() {
            const [view, setView] = useState('player'); 
            const [file, setFile] = useState(null);
            const [lyrics, setLyrics] = useState([]);
            const [backupLyrics, setBackupLyrics] = useState([]); 
            const [isLoading, setIsLoading] = useState(false);
            const [loadingStep, setLoadingStep] = useState(""); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [coverIndex, setCoverIndex] = useState(0);
            const [error, setError] = useState("");
            const [songTitle, setSongTitle] = useState("Parça Bekleniyor...");
            const [artistName, setArtistName] = useState("Gemini AI");
            
            // SCROLL & SYNC STATE
            const [userHasScrolled, setUserHasScrolled] = useState(false);
            const [activeIndex, setActiveIndex] = useState(-1);
            const [syncDirection, setSyncDirection] = useState('down'); 
            
            const [isLeftMenuOpen, setIsLeftMenuOpen] = useState(false); 
            const [isUploadSheetOpen, setIsUploadSheetOpen] = useState(false);
            const [modelName, setModelName] = useState("gemini-3-flash-preview"); 
            const [userApiKey, setUserApiKey] = useState(""); 
            
            const [manualIndex, setManualIndex] = useState(0);
            const [justMarked, setJustMarked] = useState(false);
            
            const audioRef = useRef(null);
            const lyricsContainerRef = useRef(null);
            const isAutoScrolling = useRef(false);
            const markingLock = useRef(false); 
            const audioInputRef = useRef(null);
            const jsonInputRef = useRef(null);

            const effectiveApiKey = userApiKey || ""; 
            const SelectedArt = ArtComponents[coverIndex % ArtComponents.length];

            // --- HELPER FUNC ---
            const selectCover = (filename) => setCoverIndex(filename.length % ArtComponents.length);
            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };
            const parseFileName = (filename) => {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                let parts = nameWithoutExt.split(' - ');
                if (parts.length < 2) parts = nameWithoutExt.split('-');
                if (parts.length >= 2) { setArtistName(parts[0].trim()); setSongTitle(parts[1].trim()); }
                else { setArtistName("Bilinmiyor"); setSongTitle(nameWithoutExt); }
            };
            const sortLyricsByTime = (lyricsArray) => [...lyricsArray].sort((a, b) => a.ms - b.ms);
            const handleCloseEditor = () => { setLyrics(sortLyricsByTime(lyrics)); setIsLeftMenuOpen(false); };

            // --- UPLOAD HANDLER ---
            const handleUploadClick = () => {
                if (!effectiveApiKey) {
                    setError("API Key girmen lazım. Gemini 3 bedava değil nurullah efendi.");
                    setView('settings');
                    return;
                }
                setIsUploadSheetOpen(true);
            };

            const handleAudioUpload = async (event) => {
                const uploadedFile = event.target.files[0];
                if (!uploadedFile) return;

                setIsUploadSheetOpen(false); 
                setFile(uploadedFile);
                parseFileName(uploadedFile.name); 
                selectCover(uploadedFile.name);
                
                setIsLoading(true);
                setError("");
                setLyrics([]);
                setUserHasScrolled(false);
                setIsPlaying(false);
                setActiveIndex(-1);

                if (audioRef.current) {
                    audioRef.current.src = URL.createObjectURL(uploadedFile);
                    audioRef.current.load();
                }

                try {
                    await analyzeWithGemini(uploadedFile);
                } catch (err) {
                    console.error(err);
                    setError(`Hata: ${err.message}`);
                    setIsLoading(false);
                }
            };

            const analyzeWithGemini = async (fileToAnalyze) => {
                const base64EncodedDataPromise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(fileToAnalyze);
                });
                const base64Data = await base64EncodedDataPromise;
                const filePart = { inlineData: { data: base64Data, mimeType: fileToAnalyze.type } };

                setLoadingStep("Gemini 3: Tek mermide hallediliyor...");
                
                const prompt = `Listen to the audio. Transcribe the lyrics and provide the EXACT start timestamp (in milliseconds) for each line. 
                FORMATTING RULES: 
                1. Group text into lines of 5-6 words max. 
                2. Every line MUST start with a Capital letter. 
                3. Return ONLY a valid JSON array of objects. 
                4. Object format: { "text": "Line content here", "ms": 1234 } 
                5. Do NOT include markdown blocks like \`\`\`json. Just the raw JSON.`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${effectiveApiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }, filePart] }],
                            generationConfig: { responseMimeType: "application/json" }
                        }),
                    }
                );

                const data = await response.json();
                if (data.error) throw new Error("API Hatası: " + data.error.message);
                
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                if (Array.isArray(result)) {
                    setLyrics(sortLyricsByTime(result));
                } else {
                    throw new Error("Model saçma bi format döndü.");
                }
                
                setIsLoading(false);
                setLoadingStep("");
            };

            const handleJsonUpload = (event) => {
                const uploadedFile = event.target.files[0];
                if (!uploadedFile) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) { setLyrics(sortLyricsByTime(json)); setError(""); setIsUploadSheetOpen(false); }
                    } catch (err) { setError("JSON bozuk."); }
                };
                reader.readAsText(uploadedFile);
            };

            const downloadJson = () => {
                if (lyrics.length === 0) { setError("İndirilecek söz yok."); return; }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lyrics, null, 2));
                const a = document.createElement('a');
                a.href = dataStr; a.download = `${songTitle || "sarki"}_lyrics.json`;
                document.body.appendChild(a); a.click(); a.remove();
            };

            const togglePlay = () => {
                if (audioRef.current) {
                    isPlaying ? audioRef.current.pause() : audioRef.current.play();
                    setIsPlaying(!isPlaying);
                }
            };

            const seekAudio = (ms) => {
                if (audioRef.current) {
                    audioRef.current.currentTime = ms / 1000;
                    if (!isPlaying) { audioRef.current.play(); setIsPlaying(true); }
                    setUserHasScrolled(false);
                }
            };
            
            // --- SYNC LOGIC ---
            const handleSync = (e) => {
                e.stopPropagation();
                if (activeIndex !== -1 && lyricsContainerRef.current) {
                    setUserHasScrolled(false);
                    isAutoScrolling.current = true;
                    const container = lyricsContainerRef.current;
                    const wrapper = container.querySelector('.lyrics-wrapper');
                    const activeElement = wrapper?.children[activeIndex];
                    
                    if (activeElement) {
                        const target = activeElement.offsetTop - (container.clientHeight / 2) + (activeElement.clientHeight / 2);
                        container.scrollTo({ top: target, behavior: 'smooth' });
                        setTimeout(() => { isAutoScrolling.current = false; }, 600);
                    }
                }
            };

            // Scroll Handler
            const handleScroll = () => {
                if (!isAutoScrolling.current && isPlaying) {
                    setUserHasScrolled(true);
                    
                    if (activeIndex !== -1 && lyricsContainerRef.current) {
                        const container = lyricsContainerRef.current;
                        const wrapper = container.querySelector('.lyrics-wrapper');
                        const activeElement = wrapper?.children[activeIndex];
                        
                        if (activeElement) {
                            const elementCenter = activeElement.offsetTop + (activeElement.clientHeight / 2);
                            const currentCenter = container.scrollTop + (container.clientHeight / 2);
                            if (elementCenter < currentCenter) {
                                setSyncDirection('up');
                            } else {
                                setSyncDirection('down');
                            }
                        }
                    }
                }
            };

            // --- EFFECTS ---
            useEffect(() => {
                if (lyrics.length === 0) return;
                const idx = lyrics.findIndex((line, index) => {
                    const nextLine = lyrics[index + 1];
                    return currentTime >= (line.ms - ANIMATION_OFFSET_MS) && (!nextLine || currentTime < (nextLine.ms - ANIMATION_OFFSET_MS));
                });
                if (idx !== activeIndex) setActiveIndex(idx);
            }, [currentTime, lyrics]);

            // AUTO SCROLL EFFECT
            useEffect(() => {
                if (view !== 'player' || userHasScrolled || !isPlaying || activeIndex === -1) return;
                const container = lyricsContainerRef.current;
                if (!container) return;
                const wrapper = container.querySelector('.lyrics-wrapper');
                const activeElement = wrapper?.children[activeIndex];
                if (activeElement) {
                    isAutoScrolling.current = true;
                    const target = activeElement.offsetTop - (container.clientHeight / 2) + (activeElement.clientHeight / 2);
                    container.scrollTo({ top: target, behavior: 'smooth' });
                    const timeout = setTimeout(() => { isAutoScrolling.current = false; }, 500); 
                    return () => clearTimeout(timeout);
                }
            }, [activeIndex, userHasScrolled, view, isPlaying]);

            const handleProgressBarClick = (e) => {
                if (!audioRef.current) return;
                const percent = (e.clientX - e.currentTarget.getBoundingClientRect().left) / e.currentTarget.getBoundingClientRect().width;
                audioRef.current.currentTime = percent * duration;
            };

            useEffect(() => {
                const audio = audioRef.current;
                if (!audio) return;
                const updateTime = () => setCurrentTime(audio.currentTime * 1000);
                const updateDuration = () => setDuration(audio.duration);
                const onEnd = () => setIsPlaying(false);
                audio.addEventListener('timeupdate', updateTime);
                audio.addEventListener('loadedmetadata', updateDuration);
                audio.addEventListener('ended', onEnd);
                return () => {
                    audio.removeEventListener('timeupdate', updateTime);
                    audio.removeEventListener('loadedmetadata', updateDuration);
                    audio.removeEventListener('ended', onEnd);
                };
            }, []);

            const mainBgStyle = {
                background: 'radial-gradient(circle at 0% 50%, #2a2a2a 0%, #000000 70%)',
                backgroundSize: '150% 150%',
                animation: 'gradientMove 10s ease infinite'
            };
            
            // MANUAL SYNC FUNCS
            const startManualSync = () => {
                if (!lyrics.length) { setError("Önce bi şarkı yükle."); return; }
                setLyrics(sortLyricsByTime(lyrics));
                setBackupLyrics(JSON.parse(JSON.stringify(lyrics)));
                setManualIndex(0); setView('manualSync');
                if (audioRef.current) { audioRef.current.currentTime = 0; audioRef.current.pause(); setIsPlaying(false); }
            };
            const cancelManualSync = () => { if (backupLyrics.length > 0) setLyrics(backupLyrics); setView('player'); };
            const finishManualSync = () => { setBackupLyrics([]); setView('player'); };
            const markTimestamp = () => {
                if (markingLock.current || !audioRef.current || manualIndex >= lyrics.length) return;
                markingLock.current = true;
                const newLyrics = [...lyrics];
                newLyrics[manualIndex].ms = Math.floor(audioRef.current.currentTime * 1000);
                setLyrics(newLyrics);
                setJustMarked(true); setTimeout(() => setJustMarked(false), 200);
                setManualIndex(prev => Math.min(prev + 1, lyrics.length - 1));
                setTimeout(() => { markingLock.current = false; }, 300);
            };
            const handleLyricEdit = (index, field, value) => {
                const newLyrics = [...lyrics];
                newLyrics[index][field] = field === 'ms' ? parseInt(value) || 0 : value;
                setLyrics(newLyrics);
            };
            const deleteLyricLine = (index) => setLyrics(lyrics.filter((_, i) => i !== index));
            const addLyricLine = () => {
                const lastMs = lyrics.length > 0 ? lyrics[lyrics.length-1].ms : 0;
                setLyrics([...lyrics, { text: "Yeni Satır", ms: lastMs + 2000 }]);
            };
            
            // Sync Button Visibility
            const isSyncVisible = userHasScrolled && isPlaying && activeIndex !== -1;

            return (
                <div className="fixed inset-0 w-full h-[100dvh] bg-black font-['Inter'] overflow-hidden overscroll-none touch-none">
                    <audio ref={audioRef} className="hidden" />
                    <input type="file" ref={audioInputRef} accept="audio/*,video/*" className="hidden" onChange={handleAudioUpload} />
                    <input type="file" ref={jsonInputRef} accept=".json" className="hidden" onChange={handleJsonUpload} />
                    <style>{`@keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 20% 50%; } 100% { background-position: 0% 50%; } }`}</style>

                    <div className="relative w-full h-full max-w-md mx-auto flex flex-col shadow-2xl transition-colors duration-700 overflow-hidden" style={view === 'manualSync' ? { background: '#000' } : mainBgStyle}>
                        
                        {/* LEFT DRAWER */}
                        <div className={`absolute inset-y-0 left-0 w-full bg-[#0a0a0a] z-[60] transform transition-transform duration-500 ease-in-out ${isLeftMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="flex flex-col h-full">
                                <div className="p-6 border-b border-gray-800 flex justify-between items-center bg-[#050505] z-10 relative shadow-md flex-shrink-0">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Edit3 size={18} className="text-blue-500"/> Editör</h2>
                                    <button onClick={handleCloseEditor} className="p-2 bg-gray-900 rounded-full text-gray-400 hover:text-white hover:bg-gray-800"><X size={20} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 pb-24 overscroll-contain">
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center"><label className="text-xs text-blue-400 uppercase tracking-wider font-bold">Sözler & Zamanlama</label><button onClick={addLyricLine} className="text-xs bg-blue-900/30 text-blue-400 px-2 py-1 rounded hover:bg-blue-900/50">+ Ekle</button></div>
                                        {lyrics.length === 0 ? (<p className="text-gray-600 text-center py-4 text-sm">Veri yok.</p>) : (
                                            lyrics.map((line, idx) => (
                                                <div key={idx} className="flex gap-2 items-start bg-[#161616] p-2 rounded-lg group border border-transparent hover:border-gray-800">
                                                    <div className="w-16 shrink-0"><input type="number" value={line.ms} onChange={(e) => handleLyricEdit(idx, 'ms', e.target.value)} className="w-full bg-[#000] text-blue-300 text-xs p-2 rounded font-mono focus:outline-none text-right" placeholder="ms"/></div>
                                                    <textarea rows={1} value={line.text} onChange={(e) => handleLyricEdit(idx, 'text', e.target.value)} className="flex-1 bg-transparent text-gray-300 text-sm p-1.5 focus:outline-none focus:text-white resize-none" placeholder="Söz..."/>
                                                    <button onClick={() => deleteLyricLine(idx)} className="p-1.5 text-gray-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14} /></button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* SETTINGS PAGE */}
                        <div className={`absolute inset-0 bg-[#121212] z-50 flex flex-col transition-transform duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] ${view === 'settings' ? 'translate-x-0' : 'translate-x-full'}`}>
                             <div className="p-6 pt-12 flex-1 overflow-y-auto">
                                <button onClick={() => setView('player')} className="text-white mb-8 flex items-center gap-2 hover:opacity-70 transition-opacity"><ArrowLeft /> Geri Dön</button>
                                <h2 className="text-3xl font-bold text-white mb-8">Ayarlar</h2>
                                <div className="space-y-6 animate-in slide-in-from-top-2">
                                    <div>
                                        <label className="text-gray-400 text-sm font-medium mb-2 block flex items-center gap-2"><Key size={14}/> Gemini API Key</label>
                                        <input type="password" placeholder="AIza..." value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} className="w-full bg-[#222] text-white p-4 rounded-xl border border-gray-800 focus:border-blue-500 focus:outline-none transition-colors" />
                                    </div>
                                    <div>
                                        <label className="text-gray-400 text-sm font-medium mb-2 block flex items-center gap-2"><Disc size={14}/> Model İsmi</label>
                                        <input type="text" value={modelName} onChange={(e) => setModelName(e.target.value)} className="w-full bg-[#222] text-white p-4 rounded-xl border border-gray-800 focus:border-blue-500 focus:outline-none transition-colors" />
                                    </div>
                                    <div className="pt-4 border-t border-gray-800 space-y-3">
                                        <button onClick={startManualSync} className="w-full bg-[#0a1535] text-blue-200 p-4 rounded-xl border border-blue-900/50 hover:bg-[#0f1d45] transition-all flex items-center justify-between group"><span className="font-semibold">Manuel Sync</span><Edit3 size={18} /></button>
                                        <button onClick={downloadJson} className="w-full bg-[#1a1a1a] text-green-400 p-4 rounded-xl border border-gray-700 hover:bg-[#222] transition-all flex items-center justify-between group"><span className="font-semibold">JSON İndir</span><FileJson size={18} /></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* MANUAL SYNC PAGE */}
                        <div className={`absolute inset-0 z-40 flex flex-col transition-transform duration-500 ${view === 'manualSync' ? 'translate-x-0' : 'translate-x-full'}`} style={{ background: 'linear-gradient(to bottom, #020410, #000000)' }}>
                            <div className="p-4 pt-8 flex-shrink-0 flex items-center justify-between bg-black/20 backdrop-blur-sm z-10">
                                <button onClick={cancelManualSync} className="text-red-400 flex items-center gap-2 hover:text-red-300 transition-colors"><X size={20}/> İptal</button>
                                <h3 className="text-blue-100 font-bold tracking-wide flex items-center gap-2"><Zap size={14} className="text-yellow-400 fill-yellow-400"/> SYNC MODE</h3>
                                <button onClick={finishManualSync} className="text-green-400 font-bold text-sm bg-green-900/20 px-3 py-1 rounded-full border border-green-800 hover:bg-green-900/40 transition-colors flex items-center gap-1"><Save size={14}/> Bitti</button>
                            </div>
                            <div className="flex-1 overflow-hidden flex flex-col items-center justify-center px-6 relative">
                                <div className={`absolute inset-0 bg-blue-500/5 pointer-events-none transition-opacity duration-200 ${justMarked ? 'opacity-100' : 'opacity-0'}`}></div>
                                <div className="text-center w-full space-y-10">
                                    <p className="text-blue-700/30 text-sm font-medium h-6 truncate transition-all blur-[1px] transform translate-y-2 opacity-50">{lyrics[manualIndex - 1]?.text || "..."}</p>
                                    <div key={manualIndex} className="py-8 relative animate-in zoom-in-95 slide-in-from-bottom-4 duration-300 fade-in fill-mode-both">
                                        <div className="absolute inset-0 bg-blue-500/10 blur-2xl rounded-full scale-110"></div>
                                        <p className="relative text-white text-3xl font-black leading-tight drop-shadow-[0_0_20px_rgba(59,130,246,0.6)]">{lyrics[manualIndex]?.text || <span className="text-gray-600 text-xl font-normal">Son satır.</span>}</p>
                                    </div>
                                    <div className="h-6 overflow-hidden"><p className="text-blue-700/40 text-sm font-medium truncate">{lyrics[manualIndex + 1]?.text || "..."}</p></div>
                                </div>
                            </div>
                            <div className="bg-[#010208] p-8 pb-12 flex-shrink-0 flex flex-col items-center gap-6 border-t border-blue-900/20 relative z-20">
                                <button onClick={markTimestamp} className={`w-full bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 text-white font-bold text-lg py-6 rounded-2xl shadow-[0_0_30px_rgba(29,78,216,0.4)] transition-all flex items-center justify-center gap-3 border border-blue-500/30 ${justMarked ? 'scale-95 bg-blue-500' : 'scale-100'}`}><CheckCircle size={28} className={`${justMarked ? 'animate-ping' : ''}`} /> <span className="tracking-wider">İŞARETLE</span></button>
                                <div className="flex items-center gap-8 w-full justify-center">
                                    <button onClick={togglePlay} className="text-white p-4 bg-white/5 rounded-full hover:bg-white/10 transition-colors border border-white/10 active:scale-90">{isPlaying ? <Pause fill="white"/> : <Play fill="white"/>}</button>
                                    <div className="text-blue-300/50 font-mono text-sm tracking-widest">{formatTime(currentTime / 1000)}</div>
                                </div>
                            </div>
                        </div>

                        {/* PLAYER VIEW */}
                        <div className={`absolute inset-0 flex flex-col transition-transform duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] ${view === 'player' ? 'translate-x-0' : '-translate-x-1/2 opacity-50'}`}>
                            {/* Upload Modal */}
                            <div className={`absolute inset-0 z-[55] bg-black/80 backdrop-blur-sm transition-opacity duration-300 ${isUploadSheetOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setIsUploadSheetOpen(false)}>
                                <div className={`absolute bottom-0 left-0 right-0 bg-[#161616] rounded-t-3xl p-6 transition-transform duration-300 transform ${isUploadSheetOpen ? 'translate-y-0' : 'translate-y-full'}`} onClick={(e) => e.stopPropagation()}>
                                    <div className="w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6"></div>
                                    <h3 className="text-white text-lg font-bold mb-4 px-2">Yükleme Seçenekleri</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => audioInputRef.current.click()} className="w-full flex items-center gap-4 bg-[#222] p-4 rounded-xl text-white hover:bg-[#2a2a2a] transition-colors group">
                                            <div className="bg-blue-600/20 p-3 rounded-full text-blue-400 group-hover:bg-blue-600 group-hover:text-white transition-colors"><Music2 size={24} /></div>
                                            <div className="text-left"><p className="font-bold">Müzik Yükle</p><p className="text-xs text-gray-500">Gemini 3 ile Tek Seferde İşle</p></div>
                                        </button>
                                        <button onClick={() => jsonInputRef.current.click()} className="w-full flex items-center gap-4 bg-[#222] p-4 rounded-xl text-white hover:bg-[#2a2a2a] transition-colors group"><div className="bg-green-600/20 p-3 rounded-full text-green-400 group-hover:bg-green-600 group-hover:text-white transition-colors"><FileJson size={24} /></div><div className="text-left"><p className="font-bold">JSON Yükle</p><p className="text-xs text-gray-500">Hazır söz dosyası</p></div></button>
                                    </div>
                                    <button onClick={() => setIsUploadSheetOpen(false)} className="w-full mt-6 py-3 text-red-400 font-medium">İptal</button>
                                </div>
                            </div>
                            
                            {/* Top Bar */}
                            <div className="pt-6 px-5 pb-2 z-30 bg-[#000000] border-b border-white/5 flex-shrink-0 relative shadow-2xl">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex gap-2"><button onClick={() => setIsLeftMenuOpen(true)} className="bg-white/10 p-2.5 rounded-full hover:bg-white/20 transition-colors backdrop-blur-md"><Menu size={20} className="text-gray-200" /></button><button onClick={() => setView('settings')} className="bg-white/10 p-2.5 rounded-full hover:bg-white/20 transition-colors backdrop-blur-md"><Settings size={20} className="text-gray-200" /></button></div>
                                    <button onClick={handleUploadClick} className={`relative bg-white/10 px-4 py-2.5 rounded-full hover:bg-white/20 transition-colors flex items-center gap-2 overflow-hidden backdrop-blur-md ${!effectiveApiKey ? 'opacity-70' : ''}`}><span className="text-xs font-bold text-gray-200">Dosya Yükle</span><Upload size={16} className="text-gray-200" /></button>
                                </div>
                                {error && (<div className="bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-lg text-sm flex items-center gap-2 mb-4 animate-in slide-in-from-top-2"><AlertCircle size={16} />{error}</div>)}
                                <div className={`transition-all duration-700 ease-out overflow-hidden ${file ? 'max-h-48 opacity-100' : 'max-h-0 opacity-0'}`}>
                                    <div className="flex items-center gap-4 mb-4"><div className="w-14 h-14 bg-neutral-800 rounded-lg overflow-hidden shadow-lg shrink-0"><SelectedArt /></div><div className="overflow-hidden"><h1 className="text-white font-bold text-lg truncate">{songTitle}</h1><p className="text-gray-400 text-xs flex items-center gap-1 font-medium">{isLoading ? <><Loader2 size={10} className="animate-spin"/> {loadingStep || "Analiz ediliyor..."}</> : artistName}</p></div></div>
                                    <div className="group relative py-2 cursor-pointer" onClick={handleProgressBarClick}>
                                        <div className="w-full h-1 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-white rounded-full relative" style={{ width: `${(currentTime / 1000 / duration) * 100}%` }}><div className="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,0.8)] opacity-0 group-hover:opacity-100 transition-opacity" /></div></div>
                                        <div className="flex justify-between text-[10px] text-gray-500 mt-1 font-mono"><span>{formatTime(currentTime / 1000)}</span><span>{formatTime(duration)}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto no-scrollbar px-6 relative overscroll-contain" ref={lyricsContainerRef} onScroll={handleScroll}>
                                {!file && !error && (<div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 space-y-4"><div className="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center"><Music size={32} /></div><p className="text-sm">Müzik yükle, sözler aksın.</p></div>)}
                                {isLoading && (<div className="absolute inset-0 flex flex-col items-center justify-center space-y-4 z-30 bg-black/60 backdrop-blur-sm"><Loader2 size={48} className="text-white animate-spin" /><p className="text-blue-300 text-sm animate-pulse font-medium text-center px-8">{loadingStep || "İşleniyor..."}</p></div>)}
                                <div className="py-[40vh] lyrics-wrapper"> 
                                    {lyrics.map((line, index) => {
                                        const isActive = index === activeIndex;
                                        return (
                                            <div key={index} onClick={() => seekAudio(line.ms)} className={`transition-all duration-500 ease-out py-4 origin-left cursor-pointer group select-none ${isActive ? 'scale-105 pl-4 opacity-100' : 'scale-100 pl-0 opacity-40 blur-[1px] hover:opacity-60 hover:blur-none'}`}>
                                                <div className={`text-lg font-bold leading-relaxed transition-all duration-500 relative ${isActive ? 'text-white' : 'text-gray-500'}`}><div className={`absolute left-[-16px] top-1 h-full w-[3px] rounded-full bg-white transition-opacity duration-300`} style={{ opacity: isActive ? 0.7 : 0 }}></div>{line.text}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            {/* SYNC BUTTON - ARTIK TITREME YOK */}
                            <div className={`absolute bottom-24 left-1/2 -translate-x-1/2 z-50 ${isSyncVisible ? 'sync-btn-visible' : 'sync-btn-exit'}`}>
                                <button 
                                    onClick={handleSync}
                                    className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full shadow-lg shadow-blue-900/40 flex items-center gap-2 text-sm font-bold transition-all active:scale-95 border border-blue-400/30 backdrop-blur-md"
                                >
                                    <span className="w-4 h-4 flex items-center justify-center">
                                        <span className={`spring-rotate transform ${syncDirection === 'down' ? 'rotate-180' : 'rotate-0'}`}>
                                            <ArrowUp size={16} />
                                        </span>
                                    </span>
                                    Senkronize Et
                                </button>
                            </div>

                            {file && (<div className="absolute bottom-8 left-0 right-0 flex flex-col items-center gap-4 z-40 pointer-events-none"><button onClick={togglePlay} className="bg-white text-black p-4 rounded-full shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:scale-110 active:scale-95 transition-all pointer-events-auto">{isPlaying ? <Pause fill="black" size={24} /> : <Play fill="black" size={24} className="ml-1" />}</button></div>)}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>