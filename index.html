<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LyricalAI Studio</title>
    
    <!-- PWA Setup -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Courier+Prime:wght@700&family=Permanent+Marker&family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Reset */
        body { background-color: #000; color: white; margin: 0; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Fonts & UI */
        .font-courier { font-family: 'Courier Prime', monospace; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-marker { font-family: 'Permanent Marker', cursive; }
        .font-default { font-family: 'Inter', sans-serif; }

        .glass-panel { background: rgba(28, 28, 30, 0.75); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-button { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        /* Animations */
        .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-in-bottom { animation: slideInBottom 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideInBottom { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .sync-btn-enter { animation: slideUpFade 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes slideUpFade { from { opacity: 0; transform: translate(-50%, 40px) scale(0.8); } to { opacity: 1; transform: translate(-50%, 0) scale(1); } }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
        .animate-ripple { animation: ripple 0.6s ease-out forwards; }
        @keyframes countPulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        .count-anim { animation: countPulse 1s ease-out infinite; }
        @keyframes breathe { 0% { background-size: 100% 100%; opacity: 0.4; } 50% { background-size: 140% 140%; opacity: 0.7; } 100% { background-size: 100% 100%; opacity: 0.4; } }
        .breathing-bg { background: radial-gradient(circle at 0% 50%, #333333 0%, #000000 60%); animation: breathe 8s ease-in-out infinite; }

        .clean-shadow { text-shadow: 0 2px 10px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5); }
        .active-line-indicator { position: absolute; left: -16px; top: 0; bottom: 0; width: 4px; background-color: rgba(255, 255, 255, 0.5); border-radius: 4px; }
        .icon-morph { position: absolute; top: 0; left: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .icon-visible { opacity: 1; transform: scale(1) rotate(0deg); }
        .icon-hidden-up { opacity: 0; transform: scale(0.5) rotate(-90deg); }
        .icon-hidden-down { opacity: 0; transform: scale(0.5) rotate(90deg); }
        
        input, textarea { appearance: none; -webkit-appearance: none; outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- ICONS & ASSETS ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            if (!window.lucide || !window.lucide.icons) return null;
            const iconData = window.lucide.icons[name] || window.lucide.icons.HelpCircle;
            return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className, ...props }, iconData.map((c, i) => React.createElement(c[0], { key: i, ...c[1] })));
        };

        const ArtCyber = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#050505]"><rect width="100" height="100" fill="#111" /><circle cx="50" cy="50" r="25" fill="none" stroke="#7928ca" strokeWidth="1"/><circle cx="50" cy="50" r="35" fill="none" stroke="#333" strokeWidth="0.5" strokeDasharray="4 2" /><path d="M50 25 L50 75 M25 50 L75 50" stroke="#fff" strokeWidth="0.5" opacity="0.2" /></svg>);
        const ArtVinyl = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#1a1a1a]"><circle cx="50" cy="50" r="45" fill="#111" stroke="#333" strokeWidth="1"/><circle cx="50" cy="50" r="15" fill="#eab308" /><circle cx="50" cy="50" r="2" fill="#000" /><text x="50" y="45" fontSize="4" textAnchor="middle" fill="#000" fontWeight="bold" fontFamily="monospace">GEMINI</text></svg>);
        const ArtAbstract = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#0f172a]"><rect x="20" y="20" width="60" height="60" rx="10" fill="#3b82f6" opacity="0.5"/><circle cx="70" cy="30" r="10" fill="#ef4444"/><circle cx="30" cy="70" r="15" fill="#10b981" opacity="0.8"/></svg>);
        const ArtWave = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#000]"><path d="M0 50 Q 25 30 50 50 T 100 50" stroke="#8b5cf6" strokeWidth="2" fill="none"/><path d="M0 60 Q 25 40 50 60 T 100 60" stroke="#ec4899" strokeWidth="2" fill="none" opacity="0.6"/></svg>);
        const ArtMinimal = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#fff]"><circle cx="50" cy="50" r="30" fill="#000"/><text x="50" y="55" fontSize="10" textAnchor="middle" fill="#fff" fontWeight="bold">LRYC</text></svg>);
        const ArtGeo = () => (<svg viewBox="0 0 100 100" className="w-full h-full bg-[#18181b]"><polygon points="50,15 90,85 10,85" fill="none" stroke="#fbbf24" strokeWidth="2"/><circle cx="50" cy="55" r="10" fill="#fbbf24"/></svg>);
        const ALBUM_ARTS = [ArtCyber, ArtVinyl, ArtAbstract, ArtWave, ArtMinimal, ArtGeo];

        const STORAGE_KEY_PROJECTS = 'lyrical_projects_v5';
        const STORAGE_KEY_SETTINGS = 'lyrical_settings_v3';
        const ANIMATION_OFFSET_MS = 300;
        const FONTS = [{ name: "Modern", class: "font-default", id: 'default' }, { name: "Daktilo", class: "font-courier", id: 'courier' }, { name: "Zarif", class: "font-playfair", id: 'playfair' }, { name: "Sinematik", class: "font-cinzel", id: 'cinzel' }, { name: "El Yazısı", class: "font-marker", id: 'marker' }];

        // --- COMPONENTS ---

        const SyncButton = ({ onClick, type, visible }) => {
            if (!visible) return null;
            return (
                <div className="absolute bottom-40 left-1/2 -translate-x-1/2 z-[50] sync-btn-enter">
                    <button onClick={(e) => { e.stopPropagation(); e.nativeEvent.stopImmediatePropagation(); onClick(e); }} className="glass-button bg-[#007AFF] text-white px-6 py-3 rounded-full flex items-center gap-3 text-sm font-bold shadow-xl border border-blue-400/30 overflow-hidden relative active:scale-95 transition-transform">
                        <div className="relative w-5 h-5 flex items-center justify-center">
                            <div className={`icon-morph ${type === 'up' ? 'icon-visible' : 'icon-hidden-down'}`}><Icon name="ArrowUp" size={20} /></div>
                            <div className={`icon-morph ${type === 'down' ? 'icon-visible' : 'icon-hidden-up'}`}><Icon name="ArrowDown" size={20} /></div>
                            <div className={`icon-morph ${type === 'center' ? 'icon-visible' : 'icon-hidden-up'}`}><Icon name="Crosshair" size={18} /></div>
                        </div>
                        <span className="whitespace-nowrap">Senkronize Et</span>
                    </button>
                </div>
            );
        };

        const ManualSyncView = ({ lyrics, setLyrics, onClose, audioRef, setIsPlaying }) => {
            const [activeIndex, setActiveIndex] = useState(0);
            const [tempLyrics, setTempLyrics] = useState(JSON.parse(JSON.stringify(lyrics)));
            const [countdown, setCountdown] = useState(null);
            const [isStarted, setIsStarted] = useState(false);
            const [rippleKey, setRippleKey] = useState(0);

            const startProcess = () => {
                if (audioRef.current) {
                    const playPromise = audioRef.current.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => { audioRef.current.pause(); audioRef.current.currentTime = 0; setIsStarted(true); setCountdown(3); })
                        .catch(() => { setIsStarted(true); setCountdown(3); });
                    }
                } else { setIsStarted(true); setCountdown(3); }
            };

            useEffect(() => {
                if (countdown === null) return;
                if (countdown > 0) { const t = setTimeout(() => setCountdown(countdown - 1), 1000); return () => clearTimeout(t); }
                else if (countdown === 0) { if (audioRef.current) { audioRef.current.currentTime = 0; audioRef.current.play().catch(e=>{}); setIsPlaying(true); } setCountdown(null); }
            }, [countdown, audioRef, setIsPlaying]);

            const handleTap = (e) => {
                e.stopPropagation(); if (!audioRef.current) return;
                setRippleKey(prev => prev + 1);
                const currentTimeMs = Math.floor(audioRef.current.currentTime * 1000);
                const newL = [...tempLyrics];
                if (activeIndex < newL.length) { newL[activeIndex].ms = currentTimeMs; setTempLyrics(newL); setActiveIndex(prev => prev + 1); }
            };

            const handleSave = () => { setLyrics(tempLyrics); onClose(); };

            return (
                <div className="fixed inset-0 z-[80] bg-black/95 backdrop-blur-3xl flex flex-col animate-in fade-in zoom-in-95 duration-300">
                    <div className="pt-12 px-6 pb-4 flex justify-between items-center z-10">
                        <button onClick={onClose} className="p-2 bg-white/5 rounded-full hover:bg-white/10 text-gray-400"><Icon name="X" size={20}/></button>
                        <h3 className="text-white font-bold text-lg">Ritim Stüdyosu</h3>
                        <button onClick={handleSave} className="px-4 py-2 bg-blue-600 rounded-full text-white font-bold text-sm hover:bg-blue-500">Kaydet</button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                        {countdown !== null && (<div className="absolute inset-0 flex items-center justify-center z-50 bg-black/60 backdrop-blur-sm"><div className="text-9xl font-black text-white count-anim font-mono">{countdown}</div></div>)}
                        {!isStarted ? (
                            <div className="text-center space-y-8 animate-in slide-in-from-bottom-10 fade-in duration-500">
                                <div className="w-32 h-32 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 mx-auto flex items-center justify-center shadow-2xl shadow-blue-900/50"><Icon name="Music2" size={48} className="text-white" /></div>
                                <div><h2 className="text-2xl font-bold text-white mb-2">Hazır mısın?</h2><p className="text-gray-400 max-w-xs mx-auto">Müzik başlayacak. Her satırın başlaması gerektiği anda butona bas.</p></div>
                                <button onClick={startProcess} className="px-12 py-4 bg-white text-black font-bold text-lg rounded-full hover:scale-105 active:scale-95 transition-all shadow-[0_0_40px_rgba(255,255,255,0.3)]">BAŞLAT</button>
                            </div>
                        ) : (
                            <div className="w-full h-full flex flex-col items-center justify-between py-8">
                                <div className="text-center space-y-4 max-w-md w-full flex-1 flex flex-col justify-center">
                                    <p className="text-blue-400 text-xs font-bold uppercase tracking-[0.2em] mb-2">SIRADAKİ SATIR</p>
                                    <div className="w-full min-h-[150px] h-auto flex items-center justify-center p-4 rounded-2xl bg-white/5 border border-white/10">
                                        <p className="text-white text-2xl md:text-3xl font-bold leading-tight transition-all duration-300 animate-in slide-in-from-bottom-4 fade-in break-words">{activeIndex < tempLyrics.length ? tempLyrics[activeIndex].text : "Şarkı Sonu"}</p>
                                    </div>
                                </div>
                                <div className="relative py-8">
                                    <div key={rippleKey} className="absolute inset-0 rounded-full border border-blue-500/50 animate-ripple pointer-events-none"></div>
                                    <button onClick={handleTap} disabled={activeIndex >= tempLyrics.length} className="w-40 h-40 md:w-56 md:h-56 rounded-full bg-gradient-to-b from-[#1a1a1a] to-black border border-white/10 active:border-blue-500/50 shadow-[0_0_60px_rgba(0,0,0,0.8)] flex flex-col items-center justify-center gap-2 group transition-all active:scale-95 active:shadow-[0_0_30px_rgba(37,99,235,0.3)] touch-manipulation cursor-pointer z-20">
                                        <div className="w-20 h-20 rounded-full bg-blue-600/20 group-active:bg-blue-600 flex items-center justify-center transition-colors duration-100 pointer-events-none"><div className="w-3 h-3 bg-blue-500 rounded-full group-active:bg-white shadow-[0_0_10px_currentColor]"></div></div>
                                        <span className="text-gray-500 font-bold text-sm tracking-widest group-active:text-blue-400 pointer-events-none">BAS</span>
                                    </button>
                                </div>
                                <p className="text-gray-600 font-mono text-sm">{activeIndex} / {tempLyrics.length}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ProjectsView = ({ projects, setView, loadProject, deleteProject, effectiveApiKey, setError }) => (
            <div className="fixed inset-0 h-full flex flex-col bg-black z-10">
                 <div className="pt-12 pb-6 px-6 flex justify-between items-center z-10 bg-gradient-to-b from-black to-transparent">
                    <div><h1 className="text-3xl font-bold text-white font-cinzel tracking-tight">LyricalAI</h1><p className="text-gray-400 text-xs tracking-wider uppercase opacity-70">Studio v3.8</p></div>
                    <button onClick={() => setView('settings')} className="glass-button p-3 rounded-full text-gray-300 hover:text-white transition-all active:scale-95"><Icon name="Settings" /></button>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pb-32 no-scrollbar">
                    {projects.length === 0 ? (
                        <div className="h-64 flex flex-col items-center justify-center text-gray-600 opacity-60 mt-12"><Icon name="Music" size={48} className="mb-4" /><p>Henüz proje yok.</p></div>
                    ) : (
                        <div className="space-y-3">
                            {projects.map(p => (
                                <div key={p.id} onClick={() => loadProject(p)} className="glass-panel p-4 rounded-2xl flex items-center justify-between active:scale-[0.98] transition-transform cursor-pointer group">
                                    <div className="flex items-center gap-4 overflow-hidden">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${p.themeMode === 'nostalgic' ? 'bg-purple-900/30 text-purple-400' : 'bg-blue-900/30 text-blue-400'}`}><Icon name={p.themeMode === 'nostalgic' ? 'Video' : 'Music2'} size={20} /></div>
                                        <div className="overflow-hidden"><h3 className="font-bold text-white truncate">{p.name}</h3><p className="text-xs text-gray-400 truncate">{p.artist || "Bilinmiyor"}</p></div>
                                    </div>
                                    <button onClick={(e) => deleteProject(e, p.id)} className="p-3 text-gray-600 hover:text-red-400"><Icon name="Trash2" size={18}/></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                <div className="absolute bottom-10 left-1/2 -translate-x-1/2 z-20 sync-btn-enter w-full px-12">
                    <button onClick={() => { if(!effectiveApiKey) { setError("Önce Ayarlardan API Key Gir."); setView('settings'); } else { setView('createProject'); } }} className="w-full bg-[#007AFF] hover:bg-[#0062cc] text-white py-4 rounded-full shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 font-bold transition-all active:scale-95 border border-blue-400/20 backdrop-blur-md"><Icon name="Plus" size={20} /> Yeni Proje</button>
                </div>
            </div>
        );

        const CreateProjectWizard = ({ setView, createNewProject, setFileBlob, setVideoBlob, analyzeFile }) => {
            const [step, setStep] = useState(1);
            const [name, setName] = useState("");
            const [audioFile, setAudioFile] = useState(null);
            const [mode, setMode] = useState('classic');
            const [font, setFont] = useState('default');
            const [customBgFile, setCustomBgFile] = useState(null);

            const handleFinish = async () => {
                if(!name || !audioFile) return;
                const newP = { 
                    id: Date.now().toString(), createdAt: new Date().toISOString(),
                    name, artist: "Bilinmiyor", themeMode: mode, fontId: font, fileName: audioFile.name, fileType: audioFile.type,
                    bgVideoType: (mode === 'nostalgic' && customBgFile) ? 'custom' : 'none', 
                    bgVideoPath: (mode === 'nostalgic' && customBgFile) ? customBgFile.name : null,
                    lyrics: []
                };
                if (mode === 'nostalgic' && customBgFile) setVideoBlob(URL.createObjectURL(customBgFile));
                setFileBlob(URL.createObjectURL(audioFile));
                
                // Immediately create project in App state
                createNewProject(newP); 
                
                // Then start analysis which updates the project in the list
                await analyzeFile(audioFile, newP, mode);
            };

            return (
                <div className="fixed inset-0 bg-black flex flex-col z-30 slide-in-bottom">
                    <div className="pt-12 px-6 pb-4 flex items-center"><button onClick={() => step === 1 ? setView('projects') : setStep(step-1)} className="text-blue-500 flex items-center gap-1 font-medium"><Icon name="ChevronLeft"/> {step === 1 ? "İptal" : "Geri"}</button></div>
                    <div className="px-8 pt-2 pb-6"><h2 className="text-3xl font-bold text-white"><span className="text-gray-500 text-lg block mb-1">Adım {step}/2</span>{step === 1 ? "Proje Detayları" : "Görünüm & Atmosfer"}</h2></div>
                    <div className="flex-1 overflow-y-auto px-6 no-scrollbar pb-32">
                        {step === 1 ? (
                            <div className="space-y-6 fade-in">
                                <div><label className="text-gray-400 text-xs font-bold uppercase tracking-wider ml-1 mb-2 block">Şarkı Adı</label><input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-[#1c1c1e] text-white p-4 rounded-2xl border border-gray-800 focus:border-blue-500 text-lg" placeholder="Şarkı İsmi..." /></div>
                                <div><label className="text-gray-400 text-xs font-bold uppercase tracking-wider ml-1 mb-2 block">Ses Dosyası</label><button onClick={()=>document.getElementById('wiz-audio').click()} className={`w-full p-8 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center gap-3 transition-all ${audioFile ? 'border-blue-500 bg-blue-500/10' : 'border-gray-800 bg-[#1c1c1e]'}`}><Icon name={audioFile ? "CheckCircle" : "Music"} size={32} className={audioFile ? "text-blue-500" : "text-gray-500"} /><span className="text-sm font-medium text-gray-300 truncate max-w-[80%]">{audioFile ? audioFile.name : "Müzik Seç"}</span></button><input type="file" id="wiz-audio" accept="audio/*" className="hidden" onChange={e=>{const f=e.target.files[0]; if(f){setAudioFile(f); if(!name)setName(f.name.split('.')[0]);}}} /></div>
                            </div>
                        ) : (
                            <div className="space-y-8 fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>setMode('classic')} className={`p-4 rounded-xl border text-left transition-all ${mode==='classic'?'bg-blue-600/20 border-blue-500':'bg-[#1c1c1e] border-transparent'}`}><Icon name="Music2" className={mode==='classic'?'text-blue-400':'text-gray-500'} mb-2/><h4 className="font-bold">Klasik</h4></button>
                                    <button onClick={()=>setMode('nostalgic')} className={`p-4 rounded-xl border text-left transition-all ${mode==='nostalgic'?'bg-purple-600/20 border-purple-500':'bg-[#1c1c1e] border-transparent'}`}><Icon name="Video" className={mode==='nostalgic'?'text-purple-400':'text-gray-500'} mb-2/><h4 className="font-bold">Nostaljik</h4></button>
                                </div>
                                {mode === 'nostalgic' && (<div className="animate-in slide-in-from-top-2"><label className="text-gray-400 text-xs font-bold uppercase tracking-wider ml-1 mb-2 block">Arka Plan Videosu</label><button onClick={()=>document.getElementById('wiz-video-custom').click()} className={`w-full p-6 rounded-xl border-2 border-dashed flex flex-col items-center justify-center gap-2 transition-all ${customBgFile ? 'border-blue-500 bg-blue-500/10' : 'border-gray-800 bg-[#1c1c1e]'}`}><Icon name={customBgFile ? "CheckCircle" : "Video"} size={24} className={customBgFile ? "text-blue-500" : "text-gray-500"} /><span className="text-xs font-medium text-gray-300 truncate max-w-[90%]">{customBgFile ? customBgFile.name : "Kendi Videonu Yükle"}</span></button><input type="file" id="wiz-video-custom" accept="video/*" className="hidden" onChange={e=>{const f=e.target.files[0]; if(f){setCustomBgFile(f);}}} /></div>)}
                                <div><label className="text-gray-400 text-xs font-bold uppercase tracking-wider ml-1 mb-2 block">Yazı Tipi</label><div className="space-y-2">{FONTS.map(f => (<button key={f.id} onClick={()=>setFont(f.id)} className={`w-full p-3 rounded-xl border text-left flex justify-between items-center ${f.class} ${font===f.id ? 'bg-white/10 border-white/30 text-white' : 'bg-[#1c1c1e] border-transparent text-gray-400'}`}>{f.name} {font===f.id && <Icon name="Check" size={16} className="text-blue-400"/>}</button>))}</div></div>
                            </div>
                        )}
                    </div>
                    <div className="absolute bottom-10 left-0 right-0 px-6 z-20"><button onClick={step === 1 ? () => setStep(2) : handleFinish} disabled={!name || !audioFile || (mode === 'nostalgic' && !customBgFile)} className={`w-full py-4 rounded-full font-bold text-lg transition-all ${(!name || !audioFile || (mode === 'nostalgic' && !customBgFile)) ? 'bg-gray-800 text-gray-500' : 'bg-[#007AFF] text-white shadow-lg shadow-blue-900/40'}`}>{step === 1 ? "Devam Et" : "Oluştur & Analiz Et"}</button></div>
                </div>
            );
        };

        const SettingsView = ({ setView, settings, saveSettings }) => (
            <div className="fixed inset-0 bg-black flex flex-col z-50 slide-in-right w-full h-full">
                <div className="pt-12 px-6 pb-6 flex items-center bg-black/80 backdrop-blur-md z-20 border-b border-white/10 shrink-0"><button onClick={() => setView('projects')} className="text-blue-500 flex items-center gap-1 font-medium z-30 relative"><Icon name="ChevronLeft"/> Projeler</button><h2 className="absolute left-0 right-0 text-center text-xl font-bold text-white pointer-events-none">Ayarlar</h2></div>
                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                     <div className="glass-panel p-6 rounded-2xl space-y-6">
                        <div className="flex items-center gap-2 text-white font-bold text-lg"><Icon name="Key" className="text-yellow-500"/> Gemini Yapılandırması</div>
                        <div><label className="text-gray-500 text-xs font-bold ml-1 mb-2 block uppercase tracking-wider">API Key</label><input type="password" value={settings.apiKey} onChange={(e) => saveSettings({...settings, apiKey: e.target.value})} className="w-full bg-[#1c1c1e] text-white p-4 rounded-xl border border-gray-800 focus:border-blue-500 font-mono text-sm" placeholder="AIza..." /></div>
                        <div><label className="text-gray-500 text-xs font-bold ml-1 mb-2 block uppercase tracking-wider">Model İsmi</label><input type="text" value={settings.modelName} onChange={(e) => saveSettings({...settings, modelName: e.target.value})} className="w-full bg-[#1c1c1e] text-white p-4 rounded-xl border border-gray-800 focus:border-blue-500 font-mono text-sm" /></div>
                    </div>
                    <p className="text-center text-gray-800 text-xs font-mono pt-4">LyricalAI v3.8 (Vault Edition)</p>
                </div>
            </div>
        );

        const EditorDrawer = ({ isOpen, onClose, lyrics, setLyrics, currentProject, updateProjectAndSave, startManualSync }) => {
            const [localTitle, setLocalTitle] = useState(currentProject?.name || "");
            const [localArtist, setLocalArtist] = useState(currentProject?.artist || "");
            useEffect(() => { if (currentProject) { setLocalTitle(currentProject.name); setLocalArtist(currentProject.artist || "Bilinmiyor"); } }, [currentProject]);
            
            const handleMetaSave = () => { 
                updateProjectAndSave({ name: localTitle, artist: localArtist, lyrics: lyrics }); 
                onClose(); 
            };
            
            return (
                 <div className={`fixed inset-y-0 left-0 w-full max-w-md bg-[#1c1c1e] z-[60] transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                    <div className="pt-12 p-6 border-b border-white/10 flex justify-between items-center bg-[#1c1c1e] z-10"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icon name="Edit3" size={18} className="text-blue-500"/> Editör</h2><button onClick={handleMetaSave} className="bg-white/10 p-2 rounded-full text-white"><Icon name="Check" size={20} /></button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-32 no-scrollbar h-full">
                         <div className="bg-black/40 p-4 rounded-xl space-y-3">
                            <div><label className="text-xs text-gray-500 font-bold uppercase">Şarkı</label><input type="text" value={localTitle} onChange={e=>setLocalTitle(e.target.value)} className="w-full bg-transparent border-b border-gray-700 focus:border-blue-500 text-white py-1"/></div>
                            <div><label className="text-xs text-gray-500 font-bold uppercase">Sanatçı</label><input type="text" value={localArtist} onChange={e=>setLocalArtist(e.target.value)} className="w-full bg-transparent border-b border-gray-700 focus:border-blue-500 text-white py-1"/></div>
                         </div>
                         <button onClick={startManualSync} className="w-full bg-blue-900/30 text-blue-400 py-3 rounded-xl font-bold text-sm border border-blue-500/30 flex items-center justify-center gap-2"><Icon name="Fingerprint" size={16}/> Manuel Ritim Tut (Tap Sync)</button>
                         <div className="flex justify-between items-center mt-4 px-2"><label className="text-xs text-blue-400 font-bold uppercase">Zaman (ms) - Söz</label><button onClick={() => setLyrics([...lyrics, {text:"Yeni Satır", ms: (lyrics[lyrics.length-1]?.ms || 0) + 2000}])} className="text-xs bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full">+ Ekle</button></div>
                        {lyrics.map((line, idx) => (
                            <div key={idx} className="flex gap-2 items-center bg-black p-3 rounded-xl border border-white/10">
                                <input type="number" value={line.ms} onChange={(e) => {const n=[...lyrics]; n[idx].ms=parseInt(e.target.value)||0; setLyrics(n)}} className="w-16 bg-transparent text-blue-400 text-sm font-mono text-right" />
                                <textarea rows={1} value={line.text} onChange={(e) => {const n=[...lyrics]; n[idx].text=e.target.value; setLyrics(n)}} className="flex-1 bg-transparent text-white text-sm resize-none ml-2" />
                                <button onClick={() => setLyrics(lyrics.filter((_, i) => i !== idx))} className="text-gray-600 hover:text-red-500 p-2"><Icon name="Trash2" size={16} /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [projects, setProjects] = useState(() => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_PROJECTS) || '[]'); } catch { return []; } });
            const [settings, setSettings] = useState(() => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS) || '{"apiKey":"", "modelName":"gemini-3-flash-preview"}'); } catch { return {apiKey:"", modelName:"gemini-3-flash-preview"}; } });
            
            // --- PERSISTENCE ENGINE ---
            // Auto-save whenever projects change
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(projects));
            }, [projects]);

            const saveSettings = (newSettings) => { setSettings(newSettings); localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(newSettings)); };
            const [view, setView] = useState('projects'); 
            const [currentProject, setCurrentProject] = useState(null);
            const [manualSyncMode, setManualSyncMode] = useState(false);
            const [fileBlob, setFileBlob] = useState(null);
            const [videoBlob, setVideoBlob] = useState(null); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [lyrics, setLyrics] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingStep, setLoadingStep] = useState("");
            const [error, setError] = useState("");
            const [isLeftMenuOpen, setIsLeftMenuOpen] = useState(false);
            const [activeIndex, setActiveIndex] = useState(-1);
            const [syncState, setSyncState] = useState({ visible: false, type: 'center' });
            const userHasScrolled = useRef(false);
            const isAutoScrolling = useRef(false);
            const audioRef = useRef(null);
            const videoRef = useRef(null);
            const lyricsContainerRef = useRef(null);
            const rafRef = useRef(null);
            const fileInputRef = useRef(null);
            const customVideoInputRef = useRef(null);
            const effectiveApiKey = settings.apiKey;
            const currentFont = currentProject ? FONTS.find(f => f.id === currentProject.fontId) || FONTS[0] : FONTS[0];
            const formatTime = (seconds) => { if (!seconds || isNaN(seconds)) return "0:00"; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs < 10 ? '0' : ''}${secs}`; };
            const sortLyricsByTime = (lyricsArray) => [...lyricsArray].sort((a, b) => a.ms - b.ms);
            
            const createNewProject = (newP) => { 
                setProjects(prev => [newP, ...prev]); 
                loadProject(newP); 
            };
            
            const loadProject = (project) => { setCurrentProject(project); setLyrics(project.lyrics || []); setFileBlob(null); setVideoBlob(null); setIsPlaying(false); setCurrentTime(0); setDuration(0); setActiveIndex(-1); setError(""); setView('player'); };
            const deleteProject = (e, projectId) => { e.stopPropagation(); if(confirm("Bu projeyi silmek istediğine emin misin?")) setProjects(prev => prev.filter(p => p.id !== projectId)); };
            
            // --- ROBUST STATE UPDATE ---
            const updateProjectAndSave = (updates) => {
                if (!currentProject) return;
                const updatedProject = { ...currentProject, ...updates };
                // Sort lyrics if present
                if (updates.lyrics) updatedProject.lyrics = sortLyricsByTime(updates.lyrics);
                
                setCurrentProject(updatedProject);
                // Functional update to avoid stale closures
                setProjects(prevProjects => prevProjects.map(p => p.id === updatedProject.id ? updatedProject : p));
            };

            const handleBackToMenu = () => {
                // FORCE SAVE current state before exiting
                if (currentProject) {
                    updateProjectAndSave({ lyrics: lyrics }); // Sync latest lyrics state to project
                }
                if(isPlaying && audioRef.current) { audioRef.current.pause(); setIsPlaying(false); }
                setView('projects');
            };

            useEffect(() => { const loop = () => { if (audioRef.current && !audioRef.current.paused) { setCurrentTime(audioRef.current.currentTime * 1000); rafRef.current = requestAnimationFrame(loop); }}; if (isPlaying) rafRef.current = requestAnimationFrame(loop); else if (rafRef.current) cancelAnimationFrame(rafRef.current); return () => { if (rafRef.current) cancelAnimationFrame(rafRef.current); }; }, [isPlaying]);
            useEffect(() => { const audio = audioRef.current; if (!audio) return; const onMeta = () => setDuration(audio.duration); const onEnded = () => setIsPlaying(false); const onTime = () => { if (!isPlaying) setCurrentTime(audio.currentTime * 1000); }; audio.addEventListener('loadedmetadata', onMeta); audio.addEventListener('ended', onEnded); audio.addEventListener('timeupdate', onTime); return () => { audio.removeEventListener('loadedmetadata', onMeta); audio.removeEventListener('ended', onEnded); audio.removeEventListener('timeupdate', onTime); }; }, [isPlaying, fileBlob]);
            useEffect(() => { const video = videoRef.current; if (video && currentProject?.themeMode === 'nostalgic') { if (isPlaying) video.play().catch(e=>{}); else video.pause(); } }, [isPlaying, currentProject, videoBlob]);
            useEffect(() => { if (lyrics.length === 0) return; const idx = lyrics.findIndex((line, index) => { const nextLine = lyrics[index + 1]; return currentTime >= (line.ms - ANIMATION_OFFSET_MS) && (!nextLine || currentTime < (nextLine.ms - ANIMATION_OFFSET_MS)); }); if (idx !== activeIndex) setActiveIndex(idx); }, [currentTime, lyrics]);
             const handleScroll = useCallback(() => {
                if (currentProject?.themeMode !== 'classic' || !isPlaying || isAutoScrolling.current || !lyricsContainerRef.current || activeIndex === -1) return;
                userHasScrolled.current = true;
                const container = lyricsContainerRef.current;
                const activeElement = container.querySelector('.lyrics-wrapper')?.children[activeIndex];
                if (activeElement) {
                    const rect = activeElement.getBoundingClientRect(); const cRect = container.getBoundingClientRect();
                    let type = 'center';
                    if (rect.bottom < cRect.top + 50) type = 'up'; else if (rect.top > cRect.bottom - 50) type = 'down';
                    setSyncState({ visible: true, type });
                }
            }, [activeIndex, isPlaying, currentProject]);
            useEffect(() => { if (view !== 'player' || userHasScrolled.current || !isPlaying || activeIndex === -1 || currentProject?.themeMode !== 'classic' || !lyricsContainerRef.current) return; const container = lyricsContainerRef.current; const activeElement = container.querySelector('.lyrics-wrapper')?.children[activeIndex]; if (activeElement) { isAutoScrolling.current = true; container.scrollTo({ top: activeElement.offsetTop - (container.clientHeight / 2) + (activeElement.clientHeight / 2), behavior: 'smooth' }); const t = setTimeout(() => { isAutoScrolling.current = false; }, 600); return () => clearTimeout(t); } }, [activeIndex, view, isPlaying, currentProject]);
            const togglePlay = () => { if (audioRef.current && fileBlob) { isPlaying ? audioRef.current.pause() : audioRef.current.play().catch(e => setError("Dosya oynatılamadı.")); setIsPlaying(!isPlaying); } };
            const seekAudio = (ms) => { if (audioRef.current && fileBlob) { audioRef.current.currentTime = ms / 1000; if(videoRef.current) videoRef.current.currentTime = ms / 1000; if (!isPlaying) { audioRef.current.play(); setIsPlaying(true); } userHasScrolled.current = false; setSyncState({ ...syncState, visible: false }); } };
            const handleReupload = (e) => { const file = e.target.files[0]; if (!file) return; setFileBlob(URL.createObjectURL(file)); setError(""); };
            const handleCustomVideoReupload = (e) => { const file = e.target.files[0]; if (!file) return; setVideoBlob(URL.createObjectURL(file)); updateProjectAndSave({bgVideoType: 'custom'}); }
            
            const analyzeFile = async (file, projectToUpdate, modeOverride = null) => {
                setIsLoading(true); setLoadingStep("Medya işleniyor...");
                const activeMode = modeOverride || projectToUpdate.themeMode;
                try {
                    const base64 = await new Promise((r) => { const reader = new FileReader(); reader.onloadend = () => r(reader.result.split(',')[1]); reader.readAsDataURL(file); });
                    setLoadingStep("Gemini 3 sözleri çıkarıyor...");
                    let prompt = activeMode === 'nostalgic' 
                        ? `Listen to the audio. Transcribe the lyrics. CRITICAL FORMATTING RULES: 1. Group the text into logical sentences. 2. Do NOT chop text into short karaoke lines. 3. Max 2 lines of text per timestamp. 4. Provide the EXACT start timestamp (in ms). 5. JSON Array format: [{"text": "First full sentence here.", "ms": 1000}]. No markdown.`
                        : `Listen to the audio. Transcribe the lyrics and provide the EXACT start timestamp (in milliseconds) for each line. FORMATTING RULES: 1. Group text into lines of 5-6 words max. 2. Every line MUST start with a Capital letter. 3. Return ONLY a valid JSON array of objects. 4. Object format: { "text": "Line content here", "ms": 1234 } 5. Do NOT include markdown blocks.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.modelName}:generateContent?key=${effectiveApiKey}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { data: base64, mimeType: file.type } }] }] }) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    if (!Array.isArray(result)) throw new Error("Format bozuk.");
                    
                    const sorted = sortLyricsByTime(result);
                    setLyrics(sorted); 
                    
                    // SAFE UPDATE: Update the specific project in the list
                    setProjects(prev => prev.map(p => p.id === projectToUpdate.id ? { ...p, lyrics: sorted } : p));
                    setCurrentProject(prev => ({ ...prev, lyrics: sorted }));

                } catch (err) { setError("Analiz Hatası: " + err.message); } finally { setIsLoading(false); }
            };
            const getVideoSrc = () => { if (!currentProject) return null; if (currentProject.bgVideoType === 'custom') return videoBlob; return null; };
            const renderAlbumArt = () => { if (!currentProject) return null; const ArtComponent = ALBUM_ARTS[currentProject.fileName.length % ALBUM_ARTS.length]; return <ArtComponent />; }
            const onSyncClick = useCallback((e) => {
                if (activeIndex !== -1 && lyricsContainerRef.current) {
                    isAutoScrolling.current = true; userHasScrolled.current = false; setSyncState(prev => ({ ...prev, visible: false }));
                    const container = lyricsContainerRef.current; const activeEl = container.querySelector('.lyrics-wrapper')?.children[activeIndex];
                    if (activeEl) { const topPos = activeEl.offsetTop - (container.clientHeight / 2) + (activeEl.clientHeight / 2); container.scrollTo({ top: topPos, behavior: 'smooth' }); }
                    setTimeout(() => { isAutoScrolling.current = false; }, 800);
                }
            }, [activeIndex]);

            return (
                <div className={`fixed inset-0 w-full h-full bg-black overflow-hidden font-default select-none ${currentFont.class}`}>
                    <audio ref={audioRef} src={fileBlob || undefined} className="hidden" onPlay={()=>setIsPlaying(true)} onPause={()=>setIsPlaying(false)} />
                    <input type="file" ref={fileInputRef} accept="audio/*" className="hidden" onChange={handleReupload}/>
                    <input type="file" ref={customVideoInputRef} accept="video/*" className="hidden" onChange={handleCustomVideoReupload}/>
                    {error && <div onClick={()=>setError("")} className="fixed bottom-8 left-4 right-4 z-[100] glass-panel bg-red-900/80 border-red-500/50 p-4 rounded-2xl text-white flex items-center gap-3 shadow-2xl slide-in-bottom cursor-pointer backdrop-blur-md"><Icon name="AlertCircle" className="text-red-400 shrink-0"/><span className="text-sm font-medium pr-4">{error}</span><Icon name="X" size={16} className="ml-auto text-white/50"/></div>}
                    {isLoading && <div className="fixed inset-0 z-[110] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-6 fade-in touch-none"><Icon name="Loader2" size={48} className="text-blue-500 animate-spin mb-6" /><p className="text-white text-lg font-bold animate-pulse text-center">{loadingStep}</p><p className="text-gray-500 text-xs mt-4">Lütfen bekleyin...</p></div>}
                    {manualSyncMode && <ManualSyncView lyrics={lyrics} setLyrics={setLyrics} onClose={() => setManualSyncMode(false)} audioRef={audioRef} setIsPlaying={setIsPlaying} />}
                    
                    <EditorDrawer isOpen={isLeftMenuOpen} onClose={()=>setIsLeftMenuOpen(false)} lyrics={lyrics} setLyrics={setLyrics} currentProject={currentProject} updateProjectAndSave={updateProjectAndSave} startManualSync={() => { setIsLeftMenuOpen(false); setManualSyncMode(true); }} />
                    
                    {view === 'projects' && <ProjectsView projects={projects} setView={setView} loadProject={loadProject} deleteProject={deleteProject} effectiveApiKey={effectiveApiKey} setError={setError} />}
                    
                    {view === 'createProject' && <CreateProjectWizard setView={setView} createNewProject={createNewProject} setFileBlob={setFileBlob} setVideoBlob={setVideoBlob} analyzeFile={analyzeFile} />}
                    {view === 'settings' && <SettingsView setView={setView} settings={settings} saveSettings={saveSettings} />}
                     <div className={`fixed inset-0 bg-black transition-transform duration-500 ${view === 'player' ? 'translate-x-0' : 'translate-x-full'}`}>
                        {currentProject && view === 'player' && (
                            <>
                                {currentProject.themeMode === 'nostalgic' ? (
                                    <div className="absolute inset-0 z-0 overflow-hidden bg-black">
                                        <video ref={videoRef} src={getVideoSrc() || undefined} className="w-full h-full object-cover opacity-70" loop muted playsInline />
                                        {(!getVideoSrc() && !videoRef.current?.readyState) && <div className="absolute top-24 left-4 z-20"><button onClick={() => customVideoInputRef.current.click()} className="bg-white/10 backdrop-blur-md border border-white/20 px-3 py-1.5 rounded-full text-[10px] text-gray-300 flex items-center gap-1 hover:bg-white/20"><Icon name="VideoOff" size={12}/> Video Yok / Değiştir</button></div>}
                                    </div>
                                ) : ( <div className="absolute inset-0 z-0 breathing-bg"></div> )}
                                <div className="pt-12 px-6 pb-4 z-30 absolute top-0 left-0 right-0 flex items-center justify-between"><button onClick={handleBackToMenu} className="glass-button p-2 px-4 rounded-full text-white flex items-center gap-1 text-sm font-bold backdrop-blur-xl"><Icon name="ChevronLeft" size={18} />Projeler</button><button onClick={() => setIsLeftMenuOpen(true)} className="glass-button p-3 rounded-full text-white backdrop-blur-xl"><Icon name="Edit3" size={18} /></button></div>
                                {!fileBlob && <div className="absolute inset-0 z-40 flex flex-col items-center justify-center p-8 text-center bg-black/80 backdrop-blur-md"><Icon name="FileAudio" size={64} className="text-gray-600 mb-6"/><h3 className="text-white font-bold text-2xl mb-2">{currentProject.fileName}</h3><p className="text-gray-400 text-sm mb-8 max-w-xs mx-auto">Dosya bulunamadı.</p><button onClick={() => fileInputRef.current.click()} className="bg-[#007AFF] px-8 py-4 rounded-full text-white font-bold shadow-lg">Müziği Seç</button></div>}
                                {currentProject.themeMode === 'classic' && (
                                    <div className={`absolute top-28 left-6 right-6 z-20 transition-all duration-500 opacity-100 scale-100 blur-0`}>
                                        <div className="flex items-center gap-5"><div className="w-20 h-20 rounded-xl overflow-hidden shadow-2xl shadow-black/50 border border-white/10 shrink-0 bg-gray-900">{renderAlbumArt()}</div><div className="overflow-hidden"><h1 className="text-2xl font-bold text-white truncate leading-tight">{currentProject.name}</h1><p className="text-gray-400 font-medium truncate">{currentProject.artist || "Bilinmiyor"}</p></div></div>
                                    </div>
                                )}
                                <div ref={lyricsContainerRef} onScroll={handleScroll} className={`absolute inset-0 overflow-y-auto no-scrollbar z-10 overscroll-contain px-6 ${currentProject.themeMode === 'nostalgic' ? 'flex items-center justify-center' : 'top-52 bottom-36'}`}>
                                    {currentProject.themeMode === 'classic' && (
                                        <div className="py-[30vh] lyrics-wrapper space-y-8">
                                            {lyrics.map((line, index) => {
                                                const isActive = index === activeIndex;
                                                return (
                                                    <div key={index} onClick={() => seekAudio(line.ms)} className={`relative transition-all duration-500 origin-left cursor-pointer pl-4 ${isActive ? 'scale-110 opacity-100 translate-x-2' : 'scale-100 opacity-30 blur-[1px]'}`}>
                                                        {isActive && <div className="active-line-indicator"></div>}
                                                        <p className={`text-2xl md:text-4xl font-bold leading-tight ${isActive ? 'text-white drop-shadow-md' : 'text-gray-400'}`}>{line.text}</p>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                    {currentProject.themeMode === 'nostalgic' && (
                                        <div className="w-full flex justify-center text-center px-4">
                                            <div className={`transition-all duration-500 transform ${activeIndex !== -1 ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`}>
                                                {activeIndex !== -1 && lyrics[activeIndex] ? (<p className={`text-white text-2xl md:text-4xl font-bold leading-relaxed tracking-wide clean-shadow ${currentFont.class}`}>{lyrics[activeIndex].text}</p>) : (<div className="h-16"></div>)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                {currentProject.themeMode === 'classic' && <SyncButton onClick={onSyncClick} type={syncState.type} visible={syncState.visible} />}
                                {fileBlob && (
                                     <div className="absolute bottom-0 left-0 right-0 pb-10 pt-6 px-8 bg-gradient-to-t from-black via-black/90 to-transparent z-30 flex flex-col items-center">
                                        <div className="w-full flex items-center gap-3 text-xs font-bold text-gray-400 mb-6 cursor-pointer py-4 group" onClick={(e)=>{if(!audioRef.current)return; const r=e.currentTarget.getBoundingClientRect(); seekAudio(((e.clientX-r.left)/r.width)*duration*1000);}}>
                                            <span className="w-8 text-right">{formatTime(currentTime / 1000)}</span>
                                            <div className="flex-1 h-1.5 bg-gray-700/50 rounded-full overflow-hidden backdrop-blur-sm"><div className="h-full bg-white rounded-full group-hover:bg-blue-400 transition-colors" style={{ width: `${(currentTime / 1000 / duration) * 100}%` }}></div></div>
                                            <span className="w-8">{formatTime(duration)}</span>
                                        </div>
                                        <div className="flex items-center gap-10">
                                            <button onClick={() => seekAudio(currentTime - 10000)} className="text-gray-400 hover:text-white"><Icon name="Rewind" size={32} /></button>
                                            <button onClick={togglePlay} className="bg-white text-black p-5 rounded-full hover:scale-105 active:scale-95 transition-all shadow-xl shadow-white/10">{isPlaying ? <Icon name="Pause" size={32} fill="currentColor" /> : <Icon name="Play" size={32} fill="currentColor" className="ml-1" />}</button>
                                            <button onClick={() => seekAudio(currentTime + 10000)} className="text-gray-400 hover:text-white"><Icon name="FastForward" size={32} /></button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
